<!DOCTYPE html>
<html>
<head>
	<title>demo</title>
	<meta charset="utf8">
	<link href="./css/bootstrap.min.css" rel="stylesheet">

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">  
    <link rel="stylesheet" href="./css/demo.css" type="text/css">
    <link rel="stylesheet" href="./css/awesomeStyle/awesome.css" type="text/css">

	<script src="./libs/jquery.min.js"></script>
	<script src="./libs/bootstrap.min.js"></script>
	
	<script type="text/javascript" src="./libs/jquery.ztree.all-3.5.js"></script>
    <script src="data.js"></script>

    <style>
	    .limit-height-dialog {
	        height: 580px;
	        overflow: auto;
	    }
        ul.ztree {
            border: none;
            background: #fff;
        }
        .ztree * {
            background-color: #fff;
            color: #aaa;
        }
        .ztree li span.button::before {
            color: #aaa;
        }
        #selected-area {
        	max-height: 70px;
        	overflow-y: auto;
        }
        .selected-item {
        	position: relative;
        	float: left;
    	    margin: 5px 10px;
		    background-color: #337ab7;
		    padding: 2px 8px;
		    border-radius: 8px;
		    color: #fff;
        }
        .remove-icon {
		    position: absolute;
		    top: -5px;
		    width: 18px;
		    text-align: center;
		    background-color: red;
		    border-radius: 10px;
		    display: none;
        }
        .selected-item:hover .remove-icon {    
        	display: inline-block;
        	cursor: pointer;
        }
        #search-result {
			display: none;
        }
        #search-result a {
        	text-decoration: none;
        }
    </style>

</head>
<body>

	<!-- 按钮触发模态框 -->
	<button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#outerModal">
		点我
	</button>

	<!-- 模态框（Modal） -->
	<div class="modal fade" id="outerModal" tabindex="-1" role="dialog" 
	aria-labelledby="outerModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" 
				aria-hidden="true">×
			</button>
			<h4 class="modal-title" id="outerModalLabel">
				新增应用
			</h4>
		</div>
		<div class="modal-body">

			<form class="form-horizontal">
				<div class="form-group">
					<label class="col-sm-2 control-label">订阅设置</label>
					<div class="col-sm-10">
						<input type="text" class="form-control" onfocus="set()" id="subscription">
					</div>
				</div>
			</form>

		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default" 
			data-dismiss="modal">
			关闭
		</button>
		<button type="button" class="btn btn-primary">
			提交
		</button>
	</div>
</div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="innerModal" tabindex="-1" role="dialog" 
aria-labelledby="innerModalLabel" aria-hidden="true">
<div class="modal-dialog">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" 
			aria-hidden="true">×
		</button>
		<h4 class="modal-title" id="innerModalLabel">
			选择订阅范围
		</h4>
	</div>
	<div class="modal-body limit-height-dialog">

		<form class="form-horizontal">
			<div class="form-group" style="margin-bottom: 0;">				
				<div class="col-sm-12">
					<input type="text" id="key" onkeyup="search('treeDemo','name',this.value)" class="form-control" placeholder="搜索">
				</div>
			</div>
			<div class="list-group" id="search-result"></div>
			<ul id="treeDemo" class="ztree"></ul>
			<div class="form-group">
	            <hr/>
	        </div>
	        <div class="form-group">
	            <div class="col-sm-12" id="selected-con">
	            	<span class="col-sm-3">已选部门/人员：</span>
	            	<div class="col-sm-9" id="selected-area">
	            		
	            	</div>
	            </div>
	        </div>
		</form>

	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-default" 
		data-dismiss="modal">
		关闭
	</button>
	<button type="button" class="btn btn-primary" onclick="save()">
		提交
	</button>
</div>
</div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script>
	var selected, checkedNodes = [];
	var sub = $('#subscription');

	// $('#outerModal').on('show.bs.modal', function () {
	// 	selected = [];	
	// })	

	// 打开内层弹窗
	function set(){
		$('#innerModal').modal('show');	
		checkedNodes = checkedNodes || [];	
	}

	// $('#innerModal').on('show.bs.modal', function () {
	// 	search.val(selected);
	// })

	// 关闭内层弹窗，保存，更新外层弹窗字段值
	function save() {
		var range = '';
		// var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		// selected = zTree.getCheckedNodes(true).filter(function(n){
		// 	return n.check_Child_State != 1;
		// });
		selected = checkedNodes;
		selected.forEach(function(s) {
			range = range + s.name + '; '
		})
		sub.val(range);
		$('#innerModal').modal('hide');
	}
</script>

<script>
	var push = [].push,
		setting = {
        view: {
            selectedMulti: true,
            showIcon: false,
            fontCss: getFontCss
        },
        check: {
            enable: true,
            chkStyle: 'checkbox',
            radioType: "level"
        },
        data: {
            simpleData: {
                enable: true,
                // idKey: "orgId",
                // pIdKey: "parentOrgId"
            }
        },
        callback: {
            onCheck: onCheck
        }
    };
    var nodesMap = {};
    var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
    var selectedArea = $('#selected-area'),
    	searchResult = $('#search-result');

    function setCheck() {
		$.fn.zTree.init($("#treeDemo"), setting, zNodes);
	}

	function onCheck() {
		var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
			nodes = zTree.getCheckedNodes(true);
		selectedArea.empty();
		
		nodes = nodes.filter(function(v){
			return v.getParentNode() === null;
		});
		console.log(nodes);

		checkedNodes = handle(nodes);
		console.log('len %s', checkedNodes.length);
		checkedNodes.forEach(function(v){
			console.log('id: %s, name %s', v.id, v.name);
		});

		console.log('-'.repeat(20));

		updateSelected(checkedNodes);
    }

    // 先找出选中节点中最上层的节点，然后遍历，半选的直接放到结果中，全选的再对children递归
	function handle(nodes){
		return nodes.reduce(function(result, v){
			var checked = v.getCheckStatus();
			if(checked.checked){
				if(!checked.half){
					result.push(v);
				} else {
					if(Array.isArray(v.children)){
						push.apply(result, handle(v.children));
					} else {
						console.log('node is checked=true, half = true, but node.children is not Array ', v);
					}
				}
			}
			return result;
		} ,[]);
	}

    function contains(arr, obj){
		var n = arr.length;
		while(n--) {
			if (obj.id===arr[n].id) {
				return true;
			};	
		}
		return false;
	}

    function updateSelected(checkedNodes) {
    	checkedNodes.forEach(function(node){
			var div = $('<div></div>');
			var span = $('<span></span>').text(node.name);
			var icon = $('<span></span>').text('x');
			div.addClass('selected-item');
			div.attr('id', node.id);
			icon.addClass('remove-icon');
			icon.on('click', function(){
				remove(node);
			});
			selectedArea.append(div);
			div.append(span);
			div.append(icon);		
		})
    }

    function remove(node) {
    	$('#' + node.id).remove();
    	checkedNodes.forEach(function(n, i){
    		if(n.id === node.id){		
    			var treeObj = $.fn.zTree.getZTreeObj('treeDemo'); 
    			treeObj.checkNode(n, false, true);
    			checkedNodes.splice(i, 1);
    		}
    	});	
    }

    function getChildren(ids,treeNode){
		ids.push(treeNode.id);
		if (treeNode.isParent){
			for(var obj in treeNode.children){
				getChildren(ids,treeNode.children[obj]);
			}
	    }
		return ids;
	}

   

    // 以下这些方法用于搜索

    var nodeList = [];

    function search(id,key,value){  
	    treeId = id;  
	    updateNodes(false);  
	    if(value != ""){  
	        var treeObj = $.fn.zTree.getZTreeObj(treeId);  
	        nodeList = treeObj.getNodesByParamFuzzy(key, value); 	       
	        if(nodeList && nodeList.length>0){  
	            updateNodes(true);  
	            searchResult.css('display', 'block');
	            updateSearch(nodeList);
	        }  
	    }else{
	    	searchResult.css('display', 'none');
	    }
	}  

	function updateSearch(nodeList){
		searchResult.empty();
		nodeList.forEach(function(n){
			var a = $('<a></a>').text(n.name);
			a.addClass('list-group-item');
			a.css('cursor', 'pointer');
			a.on('click', function(){
				var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
				treeObj.selectNode(n);
			});
			searchResult.append(a);
		})
	}

	function updateNodes(highlight) {  
	    var treeObj = $.fn.zTree.getZTreeObj(treeId);  
	    for( var i=0; i<nodeList.length;  i++) {  
	        nodeList[i].highlight = highlight;  
	        treeObj.updateNode(nodeList[i]);  
	    }  
	}  

	function getFontCss(treeId, treeNode) {
		return (!!treeNode.highlight) ? {color:"#A60000", "font-weight":"bold"} : {color:"#333", "font-weight":"normal"};
	}

    $(document).ready(function(){
    	zNodes.forEach(function(z){
    		checkedNodes.forEach(function(c){
    			if(c.id === z.id){
    				z.checked = true;
    				z.open = true;
    			}
    		})
    	})
        $.fn.zTree.init($("#treeDemo"), setting, zNodes);
		setCheck();			
		$("#r1").bind("change", setCheck);
		$("#r2").bind("change", setCheck);
		$("#disablechk").bind("change", setCheck);
    });

</script>

</body>
</html>